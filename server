from flask import Flask, request
import sqlite3, json

app = Flask(__name__)

DB = "metrics.db"

def save_to_db(payload):
    conn = sqlite3.connect(DB)
    c = conn.cursor()
    c.execute("""CREATE TABLE IF NOT EXISTS metrics (
                 host TEXT, timestamp INTEGER, data TEXT)""")
    c.execute("INSERT INTO metrics VALUES (?, ?, ?)", 
              (payload["host"], payload["timestamp"], json.dumps(payload)))
    conn.commit()
    conn.close()

@app.post("/api/metrics")
def receive_metrics():
    payload = request.json
    save_to_db(payload)
    return {"status": "ok"}

app.run(port=5000)